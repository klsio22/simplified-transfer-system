#!/bin/bash

# Simplified Transfer System - Helper Script
# Comandos Ãºteis para desenvolvimento e testes

function ps {
    docker compose ps
}

function up {
    docker compose up -d "${@}"
}

function down {
    docker compose down "${@}"
}

function logs {
    SERVICE="${1:-app}"
    docker compose logs -f "${SERVICE}"
}

function shell {
    docker compose exec app bash
}

function composer {
    docker run --rm --interactive \
        -e COMPOSER_CACHE_DIR="/app/.cache/composer" \
        -u "$(id -u):$(id -g)" -v "$(pwd):/app" \
        -w /app composer:2.7.2 composer "${@}"
}

function test {
    TEST_PATH="${@:-tests}"
    docker compose exec app ./vendor/bin/phpunit --colors=always "${TEST_PATH}"
}

function phpstan {
    docker compose exec app ./vendor/bin/phpstan analyse -c phpstan.neon --memory-limit=512M
}

function cs-fix {
    docker compose exec app ./vendor/bin/php-cs-fixer fix
}

function cs-check {
    docker compose exec app ./vendor/bin/php-cs-fixer fix --dry-run --diff
}

function mysql {
    docker compose exec mysql mysql -u transfer_user -ptransfer_pass -D simplified_transfer
}

function redis {
    docker compose exec redis redis-cli
}

function help {
    cat << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       Simplified Transfer System - Available Commands           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ³ Docker
  ps                  - Listar status dos containers
  up [options]        - Iniciar containers (background: -d)
  down [options]      - Parar containers
  logs [service]      - Ver logs do serviÃ§o (padrÃ£o: app)
  shell               - Acessar bash do container app

ðŸ“¦ Composer
  composer [cmd]      - Executar comandos do composer

ðŸ§ª Testes e Qualidade
  test [path]         - Rodar testes PHPUnit (padrÃ£o: tests)
  phpstan             - AnÃ¡lise estÃ¡tica com PHPStan (level 8)
  cs-fix              - Corrigir formataÃ§Ã£o (PHP-CS-Fixer)
  cs-check            - Verificar formataÃ§Ã£o sem alterar

ðŸ—„ï¸  Banco de Dados
  mysql               - Acessar console MySQL

ðŸ’¾ Cache
  redis               - Acessar console Redis

â“ Ajuda
  help                - Exibir este menu

Exemplos:
  ./run up -d         # Iniciar containers em background
  ./run test          # Rodar todos os testes
  ./run test tests/Unit/UserTest.php  # Rodar teste especÃ­fico
  ./run phpstan       # AnÃ¡lise estÃ¡tica
  ./run logs nginx    # Ver logs do Nginx
  ./run shell         # Acessar bash do app

EOF
}

# Se nenhum argumento, mostrar ajuda
if [[ $# -eq 0 ]]; then
    help
    exit 0
fi

TIMEFORMAT=$'\nTask completed in %3lR'
time ${@}